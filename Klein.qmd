---
title: "Klein"
author: "Esther KLEIN"
format: html
editor: visual
---

## Question 1

```{r message=FALSE, warning=FALSE}
library(readr)
library(here)
courses <- read_csv(here("courses.csv"), show_col_types = FALSE)
```



## Question 2

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(knitr)

courses |> 
  rename(
    course_name = course,
    identifier = course_id,
    number_of_exams = nb_grades
  ) |> 
  arrange(course_name) |> 
  kable()
```

## Question 3 

```{r message=FALSE, warning=FALSE}

students <- read_csv(here("students.csv"),show_col_types = FALSE) |>
  mutate(
    birth_date = as.Date(birth_date),
    sex = factor(sex)
  )

birth_date_class <- class(students$birth_date)
sex_class <- class(students$sex)

students |>
  slice_head(n = 5) |>
  kable()
```

The `birth_date` column of the students data frame is of class `r birth_date_class`.
The `sex` column of the students data frame is of class `r sex_class`.


## Question 4 


```{r message=FALSE, warning=FALSE}
library(readr)

grades <- read_delim(
  "grades.csv",
  delim = "|",
  na = "$",
  show_col_types = FALSE
)


```


## Question 5

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)

students |>
  count(group, name = "nb_students") |>
  ggplot(aes(x = factor(group), y = nb_students)) +
  geom_col() +
  labs(x = "Group", y = "Number of students")
```

## Question 6 

```{r message=FALSE, warning=FALSE}

students |>
  count(group, sex) |>
  ggplot(aes(x = group, y = n, fill = sex)) +
  geom_col()
```


## Question 7

```{r message=FALSE, warning=FALSE}
library(lubridate)

students |>
  mutate(age = time_length(today() - birth_date, unit = "year")) |>
  ggplot(aes(x = age)) +
  labs(x = "Age", y = "Number of students") +
  geom_histogram()
```

## Question 8 

```{r message=FALSE, warning=FALSE}
median_age <- students |>
  mutate(age = time_length(today() - birth_date, unit = "year")) |>
  group_by(group) |>
  summarise(median_age = round(median(age)))

median_age |>
  kable()
```

## Question 9 

```{r message=FALSE, warning=FALSE}
oldest <- students |>
  mutate(age = round(time_length(today() - birth_date, unit = "year"))) |>
  group_by(group) |>
  filter(age == max(age)) |>
  ungroup() |>
  arrange(desc(age)) |>
  select(id, group, sex, age)

oldest |>
  kable()
```

## Question 10

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)

nb_grades <- grades |>
  drop_na(grade) |>
  nrow()
```


The data set contains `r nb_grades` grades.

## Question 11

```{r message=FALSE, warning=FALSE}
cna_id <- courses |>
  filter(course == "Celestial Navigation and Astronomy") |>
  pull(course_id)

avg_cna <- students |>
  inner_join(grades, by = "id") |>
  filter(course_id == cna_id) |>
  group_by(group) |>
  summarise(mean_grade = mean(grade, na.rm = TRUE))

avg_cna |>
  ggplot(aes(x = group, y = mean_grade)) +
  geom_col()
```


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)

grades_trimester <- grades |>
  inner_join(courses, by = "course_id")

grades_trimester |>
  ggplot(aes(x = factor(trimester), y = grade)) +
  geom_boxplot()
```

## Question 13
```{r message=FALSE, warning=FALSE}

grades_per_student <- grades |>
  filter(!is.na(grade)) |>
  group_by(id) |>
  summarise(nb_grades = n()) |>
  inner_join(students, by = "id") |>
  select(id, group, sex, nb_grades)


grades_per_student |>
  slice_head(n = 5) |>
  kable()

summary_table <- grades_per_student |>
  summarise(
    min = min(nb_grades),
    max = max(nb_grades),
    mean = mean(nb_grades),
    median = median(nb_grades)
  )
```

Here are the summary statistics for the number of grades per student:

`r knitr::kable(summary_table)`

## Question 14
```{r message=FALSE, warning=FALSE}
library(ggplot2)

grades_per_student |>
  ggplot(aes(x = sex, y = nb_grades)) +
  geom_boxplot()
```

The distribution of grades seems to be the same for female and male students. 


## Question 15
```{r message=FALSE, warning=FALSE}

emc_id <- courses |>
  filter(course == "Elemental Mastery and Control") |>
  pull(course_id)

emc_counts <- grades |>
  filter(course_id == emc_id) |>
  group_by(id) |>
  summarise(nb_grades = n())

emc_per_student <- students |>
  inner_join(emc_counts, by = "id") |>
  select(id, group, nb_grades)

emc_per_student |>
  slice_head(n = 5) |>
  kable()
```

## Question 16

```{r message=FALSE, warning=FALSE}
emc_distribution <- emc_per_student |>
  count(nb_grades)

emc_distribution |>
  ggplot(aes(x = nb_grades, y = n)) +
  geom_col() +
labs(
    x = "Number of grades in Elemental Mastery and Control",
    y = "Number of students"
  )
```

## Question 17
```{r message=FALSE, warning=FALSE}
emc_per_student |>
  ggplot(aes(x = group, y = nb_grades)) +
  geom_boxplot() + 
  labs(x = "Group", y = "Number of grades in EMC")
```
## Question 18 

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)

emc_with_sex <- emc_per_student |>
  inner_join(select(students, id, sex), by = "id")

emc_with_sex |>
  ggplot(aes(x = group, y = nb_grades, color = sex)) +
  geom_boxplot()
```


## Question 19 
```{r message=FALSE, warning=FALSE}
avg_per_course <- grades |>
  filter(!is.na(grade)) |>
  group_by(id, course_id) |>
  summarise(avg_grade = mean(grade), .groups = "drop")

avg_with_group <- avg_per_course |>
  inner_join(select(students, id, group), by = "id")

avg_named <- avg_with_group |>
  inner_join(select(courses, course_id, course), by = "course_id")

avg_wide <- avg_named |>
  select(id, group, course, avg_grade) |>
  pivot_wider(
    names_from = course,
    values_from = avg_grade
  )

avg_wide |>
  select(id, group, 3:4) |>
  slice_head(n = 5) |>
  kable()

```
## Question 20
```{r message=FALSE, warning=FALSE}

avg_wide |>
  ggplot(aes(x = `History of the Arcane`,
             y = `Swordsmanship and Martial Arts`)) +
  geom_point() +
  labs(
    x = "Average grade in History of the Arcane",
    y = "Average grade in Swordsmanship and Martial Arts"
  )
```

## Question 21
```{r message=FALSE, warning=FALSE}
library(dplyr)

correlation_by_group <- avg_wide |>
  group_by(group) |>
  summarise(
    corr = cor(
      `Swordsmanship and Martial Arts`,
      `Necromancy and Spirit Summoning`,
      use = "complete.obs"
    )
  )

correlation_by_group
```



## Question 22
```{r message=FALSE, warning=FALSE}
best_group <- correlation_by_group |>
  mutate(abs_corr = abs(corr)) |>
  arrange(desc(abs_corr)) |>
  slice(1) |>
  pull(group)

best_data <- avg_wide |>
  filter(group == best_group)

best_data |>
  ggplot(aes(x = `Necromancy and Spirit Summoning`,
             y = `Swordsmanship and Martial Arts`)) +
  geom_point() +
  labs(
    x = "Average grade in Necromancy and Spirit Summoning",
    y = "Average grade in Swordsmanship and Martial Arts",
    title = paste("Group", best_group)
  )
```
